name: generate
on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 8 * * *"
permissions:
  contents: read
jobs:
  docs:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          token: ${{ secrets.GH_PAT }}
      - uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: go.mod
          cache: true
      - uses: go-task/setup-task@0ab1b2a65bc55236a3bc64cde78f80e20e8885c2 # v1.0.0
        with:
          version: 3.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: "install tools"
        run: |
          mkdir -p ~/bin
          wget -O ~/bin/gofumpt https://github.com/mvdan/gofumpt/releases/download/v0.9.1/gofumpt_v0.9.1_linux_amd64
          chmod +x ~/bin/gofumpt
          wget -O jv.tar.gz https://github.com/santhosh-tekuri/jsonschema/releases/download/v6.0.2/jv-v6.0.2-linux-amd64.tar.gz
          tar xzvf jv.tar.gz -C ~/bin jv
          chmod +x ~/bin/jv
          rm jv.tar.gz
          echo "$HOME/bin" >> $GITHUB_PATH
      - run: task docs:releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - run: task docs:generate
      - run: task schema:generate
      - run: task schema:validate
      - run: task nix:licenses:generate
      - run: "git pull"
      - uses: stefanzweifel/git-auto-commit-action@28e16e81777b558cc906c8750092100bbb34c5e3 # v7.0.0
        with:
          commit_message: "chore: auto-update generated files"
          branch: main
          commit_user_name: actions-user
          commit_user_email: actions@github.com
          commit_author: actions-user <actions@github.com>
  notify:
    runs-on: ubuntu-latest
    needs:
      - docs
    if: ${{ failure() }}
    steps:
      - name: Notify
        uses: nobrayner/discord-webhook@1766a33bf571acdcc0678f00da4fb83aad01ebc7 # v1
        with:
          github-token: ${{ secrets.github_token }}
          title: "generate job failed"
          description: "this may cause goreleaser-action to fail, please check: https://github.com/goreleaser/goreleaser/actions/workflows/generate.yml"
          discord-webhook: ${{ secrets.NIGHTLY_DISCORD_WEBHOOK }}
          username: GoReleaser
          avatar-url: https://avatars.githubusercontent.com/u/24697112?v=4
          include-details: false
